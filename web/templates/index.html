<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            color: #eee;
            overflow: hidden;
        }
        #graph { width: 100vw; height: 100vh; }

        .node-label {
            font-size: 10px;
            fill: #fff;
            pointer-events: none;
            text-anchor: middle;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .server-label {
            font-size: 13px;
            font-weight: bold;
            fill: #ff836b;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 15px;
            top: 15px;
            bottom: 15px;
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .panel {
            background: rgba(10, 15, 30, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .panel h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .panel h3::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #0f0;
            box-shadow: 0 0 8px #0f0;
        }

        /* Status */
        .status-panel {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #0f0;
            box-shadow: 0 0 10px #0f0;
            animation: pulse 2s infinite;
        }
        .status-dot.disconnected {
            background: #f44;
            box-shadow: 0 0 10px #f44;
            animation: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-text { font-size: 13px; }

        /* Users list */
        .users-panel { flex: 0 0 auto; max-height: 250px; }
        #users-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 180px;
            overflow-y: auto;
        }
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0, 170, 255, 0.1);
            border: 1px solid rgba(0, 170, 255, 0.2);
            border-radius: 8px;
            font-size: 12px;
            transition: all 0.2s;
        }
        .user-item:hover {
            background: rgba(0, 170, 255, 0.2);
        }
        .user-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #0af;
            box-shadow: 0 0 6px #0af;
        }
        .user-name { flex: 1; font-weight: 500; }
        .user-time { color: #666; font-size: 10px; }
        .user-count {
            background: rgba(0, 170, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: #0af;
        }

        /* Logs */
        .logs-panel { flex: 1; min-height: 0; display: flex; flex-direction: column; }
        #logs {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .log-entry {
            padding: 6px 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            font-size: 11px;
            border-left: 3px solid #ff836b;
            font-family: monospace;
        }
        .log-entry.connect { border-left-color: #0f0; background: rgba(0,255,0,0.05); }
        .log-entry.disconnect { border-left-color: #f44; background: rgba(255,0,0,0.05); }
        .log-time { color: #666; }
        .log-from { color: #0af; }
        .log-to { color: #ff836b; }
        .log-type { color: #888; font-size: 10px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        /* Link styles */
        .link-line {
            stroke: rgba(0, 170, 255, 0.3);
            stroke-width: 2;
        }
        .link-line-glow {
            stroke: rgba(0, 170, 255, 0.1);
            stroke-width: 8;
        }
    </style>
</head>
<body>
<svg id="graph"></svg>

<div class="sidebar">
    <div class="panel status-panel">
        <div class="status-dot" id="status-dot"></div>
        <span class="status-text" id="status">Connexion...</span>
    </div>

    <div class="panel users-panel">
        <h3>Utilisateurs connectes <span class="user-count" id="user-count">0</span></h3>
        <div id="users-list"></div>
    </div>

    <div class="panel logs-panel">
        <h3>Activite</h3>
        <div id="logs"></div>
    </div>
</div>

<script>
    // Data
    let nodes = [{ id: 'SERVER', type: 'server' }];
    let links = [];
    let clientsData = {};

    // SVG Setup
    const width = window.innerWidth;
    const height = window.innerHeight;

    const svg = d3.select('#graph')
        .attr('width', width)
        .attr('height', height);

    // Defs
    const defs = svg.append('defs');

    // Server gradient
    const serverGrad = defs.append('radialGradient')
        .attr('id', 'serverGradient')
        .attr('cx', '30%').attr('cy', '30%');
    serverGrad.append('stop').attr('offset', '0%').attr('stop-color', '#ff836b');
    serverGrad.append('stop').attr('offset', '100%').attr('stop-color', '#c44');

    // Client gradient
    const clientGrad = defs.append('radialGradient')
        .attr('id', 'clientGradient')
        .attr('cx', '30%').attr('cy', '30%');
    clientGrad.append('stop').attr('offset', '0%').attr('stop-color', '#4af');
    clientGrad.append('stop').attr('offset', '100%').attr('stop-color', '#08a');

    // Glow filters
    const glowServer = defs.append('filter').attr('id', 'glowServer').attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
    glowServer.append('feGaussianBlur').attr('stdDeviation', '4').attr('result', 'blur');
    glowServer.append('feFlood').attr('flood-color', '#ff836b').attr('flood-opacity', '0.5');
    glowServer.append('feComposite').attr('in2', 'blur').attr('operator', 'in');
    const mergeServer = glowServer.append('feMerge');
    mergeServer.append('feMergeNode');
    mergeServer.append('feMergeNode').attr('in', 'SourceGraphic');

    const glowClient = defs.append('filter').attr('id', 'glowClient').attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
    glowClient.append('feGaussianBlur').attr('stdDeviation', '3').attr('result', 'blur');
    glowClient.append('feFlood').attr('flood-color', '#0af').attr('flood-opacity', '0.4');
    glowClient.append('feComposite').attr('in2', 'blur').attr('operator', 'in');
    const mergeClient = glowClient.append('feMerge');
    mergeClient.append('feMergeNode');
    mergeClient.append('feMergeNode').attr('in', 'SourceGraphic');

    // Groups
    const linkGlowGroup = svg.append('g').attr('class', 'link-glows');
    const linkGroup = svg.append('g').attr('class', 'links');
    const nodeGroup = svg.append('g').attr('class', 'nodes');
    const labelGroup = svg.append('g').attr('class', 'labels');
    const particleGroup = svg.append('g').attr('class', 'particles');

    // Force simulation
    const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(180).strength(0.5))
        .force('charge', d3.forceManyBody().strength(-400))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(60))
        .on('tick', ticked);

    function ticked() {
        linkGlowGroup.selectAll('line')
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        linkGroup.selectAll('line')
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        nodeGroup.selectAll('circle')
            .attr('cx', d => d.x)
            .attr('cy', d => d.y);

        labelGroup.selectAll('text')
            .attr('x', d => d.x)
            .attr('y', d => d.y + (d.type === 'server' ? 50 : 38));
    }

    function update() {
        // Link glows
        const linkGlow = linkGlowGroup.selectAll('line').data(links, d => `${d.source.id || d.source}-${d.target.id || d.target}`);
        linkGlow.exit().remove();
        linkGlow.enter().append('line').attr('class', 'link-line-glow');

        // Links
        const link = linkGroup.selectAll('line').data(links, d => `${d.source.id || d.source}-${d.target.id || d.target}`);
        link.exit().remove();
        link.enter().append('line').attr('class', 'link-line');

        // Nodes
        const node = nodeGroup.selectAll('circle').data(nodes, d => d.id);
        node.exit().transition().duration(300).attr('r', 0).remove();
        node.enter()
            .append('circle')
            .attr('r', 0)
            .attr('fill', d => d.type === 'server' ? 'url(#serverGradient)' : 'url(#clientGradient)')
            .attr('filter', d => d.type === 'server' ? 'url(#glowServer)' : 'url(#glowClient)')
            .attr('cursor', 'pointer')
            .attr('stroke', d => d.type === 'server' ? 'rgba(255,131,107,0.5)' : 'rgba(0,170,255,0.3)')
            .attr('stroke-width', 2)
            .call(drag(simulation))
            .transition().duration(600).ease(d3.easeElasticOut)
            .attr('r', d => d.type === 'server' ? 40 : 22);

        // Labels
        const label = labelGroup.selectAll('text').data(nodes, d => d.id);
        label.exit().remove();
        label.enter()
            .append('text')
            .attr('class', d => d.type === 'server' ? 'node-label server-label' : 'node-label')
            .text(d => d.id)
            .attr('opacity', 0)
            .transition().duration(500)
            .attr('opacity', 1);

        simulation.nodes(nodes);
        simulation.force('link').links(links);
        simulation.alpha(0.5).restart();
    }

    function drag(simulation) {
        return d3.drag()
            .on('start', (event, d) => {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            })
            .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
            .on('end', (event, d) => {
                if (!event.active) simulation.alphaTarget(0);
                if (d.type !== 'server') { d.fx = null; d.fy = null; }
            });
    }

    function animateMessage(from, to, type) {
        const source = nodes.find(n => n.id === from);
        const target = nodes.find(n => n.id === to);
        if (!source || !target) return;

        const colors = { TEXT: '#0f0', AUDIO: '#f0f', IMAGE: '#ff0', VIDEO: '#f80' };
        const color = colors[type] || '#0af';

        const particle = particleGroup.append('circle')
            .attr('r', 6)
            .attr('fill', color)
            .attr('filter', 'url(#glowClient)')
            .attr('cx', source.x)
            .attr('cy', source.y);

        particle.transition().duration(400).ease(d3.easeQuadOut)
            .attr('cx', target.x).attr('cy', target.y)
            .attr('r', 10)
            .transition().duration(150)
            .attr('r', 0).remove();
    }

    // Users list rendering
    function renderUsersList() {
        const list = document.getElementById('users-list');
        const clients = nodes.filter(n => n.type === 'client');
        document.getElementById('user-count').textContent = clients.length;

        list.innerHTML = clients.map(c => {
            const data = clientsData[c.id] || {};
            const time = data.connected_at ? data.connected_at.split('T')[1]?.split('.')[0] : '';
            return `<div class="user-item">
                    <div class="user-dot"></div>
                    <span class="user-name">${c.id}</span>
                    <span class="user-time">${time}</span>
                </div>`;
        }).join('');
    }

    function addClient(username, data = {}) {
        if (nodes.find(n => n.id === username)) return;
        nodes.push({ id: username, type: 'client' });
        links.push({ source: 'SERVER', target: username });
        clientsData[username] = data;
        update();
        renderUsersList();
    }

    function removeClient(username) {
        nodes = nodes.filter(n => n.id !== username);
        links = links.filter(l => (l.source.id || l.source) !== username && (l.target.id || l.target) !== username);
        delete clientsData[username];
        update();
        renderUsersList();
    }

    function addLog(type, html) {
        const logsDiv = document.getElementById('logs');
        const div = document.createElement('div');
        div.className = 'log-entry ' + type;
        div.innerHTML = html;
        logsDiv.insertBefore(div, logsDiv.firstChild);
        if (logsDiv.children.length > 50) logsDiv.removeChild(logsDiv.lastChild);
    }

    // SSE
    const eventSource = new EventSource('/api/stream');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status');

    eventSource.onopen = () => {
        statusDot.classList.remove('disconnected');
        statusText.textContent = 'Connecte';
    };

    eventSource.onmessage = (e) => {
        const event = JSON.parse(e.data);
        const time = event.timestamp.split('T')[1].split('.')[0];

        if (event.type === 'routing') {
            const d = event.data;
            addLog('routing', `<span class="log-time">${time}</span> <span class="log-from">${d.emitter}</span> → <span class="log-to">${d.receiver}</span> <span class="log-type">${d.message_type}</span>`);
            animateMessage(d.emitter, d.receiver, d.message_type);
        }
        else if (event.type === 'client_connected') {
            addLog('connect', `<span class="log-time">${time}</span> <span style="color:#0f0">+</span> ${event.data.username}`);
            addClient(event.data.username, event.data);
        }
        else if (event.type === 'client_disconnected') {
            addLog('disconnect', `<span class="log-time">${time}</span> <span style="color:#f44">−</span> ${event.data.username}`);
            removeClient(event.data.username);
        }
        else if (event.type === 'client_list') {
            event.data.forEach(c => addClient(c.username, c));
        }
    };

    eventSource.onerror = () => {
        statusDot.classList.add('disconnected');
        statusText.textContent = 'Deconnecte';
    };

    fetch('/api/clients').then(r => r.json()).then(data => {
        data.forEach(c => addClient(c.username, c));
    });

    update();

    window.addEventListener('resize', () => {
        const w = window.innerWidth, h = window.innerHeight;
        svg.attr('width', w).attr('height', h);
        simulation.force('center', d3.forceCenter(w / 2, h / 2));
        simulation.alpha(0.3).restart();
    });
</script>
</body>
</html>
